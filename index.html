<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon.png" />
  <title>DeadlineDog</title>
  <style>
    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
      /* background-color: #f9e6ec; */
      background-color: #f3e5e8;
      color: #333;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 30px;
      /* background-color: #f2d4dc; */
      background-color: #f3e5e8;
    }

    header .logo {
      font-size: 24px;
      font-weight: bold;
      color: #c06c84;
    }

    header .nav-buttons button {
      margin-left: 10px;
      padding: 8px 16px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 20px;
      cursor: pointer;
    }

    main {
      display: flex;
      padding: 20px;
      gap: 20px;
      flex-wrap: wrap;
    }

    .section {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 250px;
      cursor: pointer;
    }

    .calendar {
      flex: 2;
      text-align: center;
    }

    .note-list,
    .friend-list {
      list-style: none;
      padding: 0;
    }

    .note-item,
    .friend-item {
      background: #fce4ec;
      margin: 8px 0;
      padding: 8px;
      border-radius: 15px;
    }

    .mood-options span {
      font-size: 24px;
      margin: 5px;
      cursor: pointer;
    }

    /* ____________button_____________ */
    .button-container {
      display: flex;
      flex-wrap: wrap;
      /* å…è¨±æ›è¡Œ */
      justify-content: center;
      /* æ°´å¹³ç½®ä¸­*/
      gap: 10px;
      /* æŒ‰éˆ•ä¹‹é–“é–“è· */
      margin-top: 20px;
    }

    .button-container button {
      width: 45%;
      /* æ¯å€‹æŒ‰éˆ•ä½”ç´„ä¸€åŠï¼ˆåŠ  gap å‰›å‰›å¥½ï¼‰ */
      min-width: 120px;
      /* é¿å…å¤ªå° */
      padding: 10px;
      border: none;
      background-color: #f6e5ec;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }

    .button-container button:hover {
      /* æ»‘é¼ æ‡¸åœæ™‚é¡è‰² */
      background-color: #e6c5c7;
    }

    .button-container a {
      color: #545353;
      text-decoration: none;
      display: block;
      width: 100%;
      height: 100%;
      font-weight: bold;
    }

    .button-container a:hover {
      text-decoration: none;
    }

    /* ________________button end______________ */
    .logo-image {
      height: 60px;
      /* æ§åˆ¶åœ–ç‰‡é«˜åº¦ */
    }

    /* _________________timer___________________ */
    .countdown-box {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .countdown-segment {
      background-color: #fff;
      border: 2px solid #d8b5c3;
      border-radius: 10px;
      width: 60px;
      height: 60px;
      text-align: center;
      font-family: 'Courier New', Courier, monospace;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .countdown-segment p {
      font-size: 12px;
      margin: 2px 0 0 0;
      color: #888;
    }

    .colon {
      font-size: 24px;
      font-weight: bold;
      color: #a78a8a;
      align-self: center;
    }

    /* _____________end of timer_________________ */

    #countdown-title {
      color: #c27ba0;
      /* font-weight: bold; */
      font-size: 16px;
    }

    .view-note-btn {
      font-size: 12px;
      padding: 4px 8px;
      background-color: #f2f2f2;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      color: #555;
      transition: all 0.2s;
    }

    .view-note-btn:hover {
      background-color: #e0d4f7;
      color: #663399;
    }

    .done-btn:hover {
      background: #ff1a1a;
      color: white;
    }

    /* mood__________________________________ */
    #date-time {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f3e5e8;
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      margin-bottom: 16px;
      font-family: 'Quicksand', 'Noto Sans TC', sans-serif;
    }

    .date-left {
      color: #f3e5e8;
    }

    .date-string {
      font-size: 1rem;
      font-weight: bold;
    }

    .weekday {
      font-size: 0.9rem;
      margin-top: 2px;
    }

    .time-right {
      font-size: 1.6rem;
      font-weight: bold;
      color: #444;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      /* å…è¨±æ›è¡Œ */
      gap: 20px;
      /* å€å¡Šä¹‹é–“é–“è·ï¼ˆå¯é¸ï¼‰ */
    }

    .section {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      flex: 1 1 200px;
      /* ç¸®æ”¾ åˆå§‹å¯¬åº¦ 200px */
      min-width: 200px;
      cursor: pointer;

      /* æ–°å¢é€™æ¢ï¼šå¼·åˆ¶å¯¬é«˜æ¯” */
  aspect-ratio: 4 / 3;
    }

    .section move-next-line {
      /* æ›è¡Œ */
      flex-basis: 100%;
    }

    /* calendar______________________________________________________ */
    .today-overview {
      background: #fff6f8;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      margin-bottom: 17px;
    }

    .calendar-preview {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 16px;
      font-size: 12px;
      text-align: center;
    }

    .calendar-preview .day {
      padding: 6px 0;
      border-radius: 50%;
      color: #999;
    }

    .calendar-preview .today {
      background-color: #fbb1d4;
      color: white;
      font-weight: bold;
    }

    .today-schedule {
      font-size: 14px;
      color: #444;
    }

    .task-item {
      margin-top: 6px;
      font-size: 13px;
      background: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      color: #555;
      border: 1px solid #eee;
    }

    #timeline-bar {
      position: relative;
      height: 80px;
      /* é©ç•¶é«˜åº¦ */
      display: flex;
      align-items: center;
      overflow-x: auto;
      padding: 0 20px;
    }

    /* é€™æ¢ç·šç”¨ä¸€å€‹å½å…ƒç´ æˆ–å­å…ƒç´ åš */
    #timeline-bar::before {
      content: "";
      position: absolute;
      top: 50%;

      left: 0;
      right: 0;
      height: 2px;
      background-color: #ccc;
      transform: translateY(-50%);
      z-index: 1;
    }

    /* æ¯å€‹é»å®¹å™¨ */
    .timeline-point {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 20px;
      z-index: 2;
      /* ç¢ºä¿é»åœ¨ç·šä¸Šæ–¹ */

      /* æ–°å¢ */
      justify-content: center;
      text-align: center;
      width: 80px;
    }

    /* é»æœ¬é«” */
    .timeline-point .dot {
      width: 14px;
      height: 14px;
      background-color: #e6c5c7;
      border-radius: 50%;
      border: 2px solid white;
      
      position: relative;
      top: 0;
      
      z-index: 3;
    }

    /* æ™‚é–“æ¨™ç±¤ï¼Œé»çš„ä¸Šæ–¹ */
    .timeline-point .time {
      font-size: 12px;
      color: #888;
      margin-bottom: 8px;
      user-select: none;
    }

    /* æ¨™é¡Œï¼Œé»çš„ä¸‹æ–¹ */
    .timeline-point .title {
      font-size: 12px;
      color: #555;
      margin-top: 8px;
      white-space: nowrap;
    }
    .now-point {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 20px;
      z-index: 2;
      /* ç¢ºä¿é»åœ¨ç·šä¸Šæ–¹ */

      /* æ–°å¢ */
      justify-content: center;
      text-align: center;
      width: 80px;
    }

    /* é»æœ¬é«” */
    .now-point .dot {
      width: 14px;
      height: 14px;
      background-color: #7f7f7f;
      border-radius: 50%;
      border: 2px solid white;

      position: relative;
      top: 0;

      z-index: 3;
    }

    /* æ™‚é–“æ¨™ç±¤ï¼Œé»çš„ä¸Šæ–¹ */
    .now-point .time {
      font-size: 12px;
      color: #888;
      margin-bottom: 8px;
      user-select: none;
    }

    /* æ¨™é¡Œï¼Œé»çš„ä¸‹æ–¹ */
    .now-point .title {
      font-size: 12px;
      color: #555;
      margin-top: 8px;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">
      <img src="logo.png" alt="DeadlineDog" class="logo-image">
    </div>
    <div class="nav-buttons">
      <button onclick="window.location.href='login.html'">Log in</button>
      <button onclick="window.location.href='signup.html'">Sign up</button>
    </div>
  </header>
  <!-- _______________event__________________ -->
  <main>
    <div class="section">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="padding-top: 3px;">Event</h3>
        <button onclick="window.location.href='event.html'" class="view-note-btn">
          â• Add / View
        </button>
      </div>
      <div style="font-weight: bold;"><span id="countdown-title">Upcoming Event Countdown</span></div>
      <div class="countdown-box">
        <div class="countdown-segment">
          <span id="days">00</span>
          <p>days</p>
        </div>
        <div class="colon">:</div>
        <div class="countdown-segment">
          <span id="hours">00</span>
          <p>hours</p>
        </div>
        <div class="colon">:</div>
        <div class="countdown-segment">
          <span id="minutes">00</span>
          <p>minutes</p>
        </div>
      </div>

      <div class="button-container">
        <button><a href="event.html#testt">Test</a></button>
        <button><a href="event.html#meetingg">Meeting</a></button>
        <button><a href="event.html#classs">Class</a></button>
        <button><a href="event.html#projectt">Project</a></button>
      </div>
    </div>
    <!-- _______________note__________________ -->
    <div class="section">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="padding-top: 3px;">Note</h3>
        <button onclick="window.location.href='note.html'" class="view-note-btn">
          â• Add / View
        </button>
      </div>
      <ul class="note-list" id="home-note-list">
        <!-- JS æœƒè‡ªå‹•å¡« -->
      </ul>
    </div>
    <!-- _______________calendar__________________ -->
    <div class="section calendar">
      <div class="today-overview">
        <div class="calendar-preview" id="calendar-preview" style="aspect-ratio: 1 / 1; width: 100%;"></div>
      </div>
      <div class="today-schedule">
        <strong>Today's Schedule</strong>
        <div id="today-task" class="task-item">Loading...</div>
      </div>
    </div>

    <!-- _______________mood__________________ -->
    <div class="section">
      <!-- ğŸ•’ ä¸ŠåŠéƒ¨ æ—¥æœŸæ™‚é–“ -->
      <div id="date-time"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 15px;">
        <div>
          <div id="date" style="font-size: 1rem; font-weight: bold; color: #c06c84;"></div>
          <div id="weekday" style="font-size: 0.9rem;  color: #c06c84"></div>
        </div>
        <div id="time" style="font-size: 1.6rem; font-weight: bold; color: #c06c84"></div>
      </div>

      <!-- ğŸ˜Š ä¸‹åŠéƒ¨ å¿ƒæƒ…é¸æ“‡ -->
      <div style="text-align: center; font-weight: bold; font-size: 1.1rem; margin-bottom: 25px; margin-top: 30px;">
        How's your day?</div>
      <div id="mood-options" style="display: flex; justify-content: space-around; font-size: 2rem; cursor: pointer;">
        <div data-mood="ğŸ˜„" title="Happy">ğŸ˜„</div>
        <div data-mood="ğŸ™‚" title="Okay">ğŸ™‚</div>
        <div data-mood="ğŸ˜" title="So-so">ğŸ˜</div>
        <div data-mood="ğŸ˜”" title="Sad">ğŸ˜”</div>
        <div data-mood="ğŸ˜¡" title="Angry">ğŸ˜¡</div>
      </div>

      <button id="show-history"
        style="margin-top: 35px; float: right; background: #e6c5c7; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer;">History</button>
    </div>
    <!-- _______________timeline__________________ -->
    <div id="timeline" class="section move-next-line" style="min-width: 600px; position: relative; flex-basis: 100%; aspect-ratio: auto;">
      <h3>Today's Timeline</h3>
      <button id="add-plan-btn" style="
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: #e6c5c7;
      color: white;
      padding: 6px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    " onclick="window.location.href='addPlan.html'">
        ï¼‹ Add Plan
      </button>
      <div id="timeline-bar" style="display: flex; overflow-x: auto; padding-top: 10px;"></div>
    </div>


  </main>

  <script>
    //mood------------------------------------------------------------------------------------
    // é¡¯ç¤ºç¾åœ¨æ™‚é–“ï¼Œä¸¦æ¯ç§’æ›´æ–°
    function updateTime() {
      const now = new Date();

      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');

      const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      const weekday = dayNames[now.getDay()];

      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');

      document.getElementById('date').textContent = `${yyyy}/${mm}/${dd}`;
      document.getElementById('weekday').textContent = weekday;
      document.getElementById('time').textContent = `${hours}:${minutes}`;
    }

    setInterval(updateTime, 1000);
    updateTime();

  </script>

  <script type="module">
    //ç™»å…¥+note____________________________________________________________________________
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { collection, query, where, orderBy, getDocs, updateDoc, doc, addDoc, serverTimestamp, getDoc, setDoc, deleteDoc, getFirestore } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // ç¢ºä¿æŠ“åˆ°æœ€æ–°çš„ä½¿ç”¨è€…è³‡æ–™
        console.log('ä½¿ç”¨è€…åç¨±:', user.displayName); //
        document.querySelector('.nav-buttons').innerHTML = `
        <span>ğŸ‘‹ ${user.displayName}</span>
        <button id="logoutBtn">Log out</button>
      `;

        document.getElementById('logoutBtn').addEventListener('click', () => {
          signOut(auth).then(() => {
            window.location.reload();
          });
        });

        // ä½¿ç”¨è€…ç™»å…¥å¾Œï¼Œè¼‰å…¥è©²ç”¨æˆ¶çš„ notes
        loadHomeNotes();
      } else {
        // å°šæœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥æŒ‰éˆ•æˆ–ç©ºç™½
        document.querySelector('.nav-buttons').innerHTML = `
        <button onclick="window.location.href='login.html'">Log in</button>
        <button onclick="window.location.href='signup.html'">Sign up</button>
      `;
      }
    });

    // import { collection, query, where, orderBy, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    async function loadHomeNotes() {
      const user = auth.currentUser;
      if (!user) {
        console.log("å°šæœªç™»å…¥");
        return;
      }

      // const notesRef = collection(db, 'users', user.uid, 'notes');
      const notesRef = collection(db, 'notes', user.uid, 'userNotes');
      const q = query(notesRef, where('done', '==', false), orderBy('date'));
      const querySnapshot = await getDocs(q);

      const homeList = document.getElementById('home-note-list');
      homeList.innerHTML = "";

      if (querySnapshot.empty) {
        const li = document.createElement('li');
        li.innerHTML = `<em style="color: #aaa;">All done! ğŸ‰</em>`;
        li.style.textAlign = "center";
        li.style.padding = "8px";
        homeList.appendChild(li);
        return;
      }

      let count = 0;
      querySnapshot.forEach(docSnap => {
        if (count >= 3) return;
        const note = docSnap.data();
        const li = document.createElement('li');
        li.className = 'note-item';
        li.style.position = "relative";
        li.style.cursor = "pointer";

        li.innerHTML = `
        <strong>${note.title}</strong><br>
        <small style="color: #777;">Deadlineï¼š${note.date}</small>
        <button class="done-btn" style="
          position: absolute;
          top: 10px;
          right: 10px;
          background: #f7cdd0;
          border: none;
          font-size: 12px;
          cursor: pointer;
          color: white;
          border-radius:8px;
          padding:8px 12px;
        ">Done</button>
      `;

        li.querySelector(".done-btn").addEventListener("click", async (event) => {
          event.stopPropagation();
          await markNoteDone(docSnap.id);
        });

        li.addEventListener("click", () => {
          window.location.href = "note.html";
        });

        homeList.appendChild(li);
        count++;
      });

      if (querySnapshot.size > 3) {
        const extra = document.createElement('li');
        extra.className = 'note-extra-count';
        extra.innerHTML = `<small>+${querySnapshot.size - 3} more</small>`;
        extra.style.textAlign = "right";
        extra.style.color = "#999";
        homeList.appendChild(extra);
      }
    }

    async function markNoteDone(noteId) {
      const user = auth.currentUser;
      if (!user) return;

      // const noteDocRef = doc(db, 'users', user.uid, 'notes', noteId);
      const noteDocRef = doc(db, 'notes', user.uid, 'userNotes', noteId);
      await updateDoc(noteDocRef, { done: true });
      loadHomeNotes();
      renderTodaySchedule(); // âœ… æ›´æ–°ä»Šå¤©çš„ä»»å‹™å€
    }

    //event____________________________________________________________________________
    const daysEl = document.getElementById('days');
    const hoursEl = document.getElementById('hours');
    const minutesEl = document.getElementById('minutes');
    const eventTitleEl = document.getElementById('countdown-title');

    auth.onAuthStateChanged(async (user) => {
      if (!user) return;

      const userEventsRef = collection(db, "events", user.uid, "userEvents");
      const snapshot = await getDocs(userEventsRef);

      const now = new Date();
      let upcomingEvent = null;
      let minDiff = Infinity;

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const eventDateTime = new Date(`${data.date}T${data.time}`);

        const diff = eventDateTime - now;
        if (diff >= 0 && diff < minDiff) {
          upcomingEvent = { ...data, id: docSnap.id };
          minDiff = diff;
        }

        // åˆªé™¤éæœŸ
        if (eventDateTime < now) {
          deleteDoc(doc(db, "events", user.uid, "userEvents", docSnap.id));
        }
      });

      if (upcomingEvent) {
        eventTitleEl.innerText = "NEXT: " + upcomingEvent.title;
        startCountdown(`${upcomingEvent.date}T${upcomingEvent.time}`, async () => {
          await deleteDoc(doc(db, "events", user.uid, "userEvents", upcomingEvent.id));
          eventTitleEl.innerText = "Not event yet";
          daysEl.textContent = hoursEl.textContent = minutesEl.textContent = '00';
        });
      } else {
        eventTitleEl.innerText = "Not event yet";
      }
    });

    function startCountdown(targetTime, onExpire) {
      const target = new Date(targetTime);

      const timer = setInterval(() => {
        const now = new Date();
        const diff = target - now;

        if (diff <= 0) {
          clearInterval(timer);
          onExpire();
          return;
        }

        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const m = Math.floor((diff / (1000 * 60)) % 60);

        daysEl.textContent = d.toString().padStart(2, '0');
        hoursEl.textContent = h.toString().padStart(2, '0');
        minutesEl.textContent = m.toString().padStart(2, '0');
      }, 1000);
    }
    //calendar___________________________________________________________________
    // import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    document.addEventListener("DOMContentLoaded", function () {
      renderMiniCalendar();
      renderTodaySchedule();
    });
    // ç­‰ç™»å…¥ç‹€æ…‹ç¢ºèªå¾Œå†åŸ·è¡Œ renderTodaySchedule
    onAuthStateChanged(auth, (user) => {
      if (user) {
        renderTodaySchedule();
      } else {
        const taskEl = document.getElementById("today-task");
        taskEl.textContent = "è«‹å…ˆç™»å…¥";
      }
    });

    function renderMiniCalendar() {
      const calendarEl = document.getElementById("calendar-preview");
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const todayDate = now.getDate();

      const firstDay = new Date(year, month, 1).getDay(); // æœˆåˆæ˜¯æ˜ŸæœŸå¹¾
      const daysInMonth = new Date(year, month + 1, 0).getDate(); // ç•¶æœˆå¤©æ•¸

      calendarEl.innerHTML = "";

      const weekdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      weekdays.forEach(day => {
        const div = document.createElement("div");
        div.textContent = day;
        div.style.fontWeight = "bold";
        calendarEl.appendChild(div);
      });

      // ç©ºæ ¼
      for (let i = 0; i < firstDay; i++) {
        calendarEl.appendChild(document.createElement("div"));
      }

      // æ—¥æœŸ
      for (let i = 1; i <= daysInMonth; i++) {
        const div = document.createElement("div");
        div.textContent = i;
        div.className = "day";
        if (i === todayDate) {
          div.classList.add("today");
        }
        calendarEl.appendChild(div);
      }
    }
    async function renderTodaySchedule() {
      const taskEl = document.getElementById("today-task");
      // const todayStr = new Date().toISOString().split("T")[0]; // yyyy-mm-dd
      const todayStr = getLocalDateStr();

      const user = auth.currentUser;
      if (!user) {
        taskEl.textContent = "è«‹å…ˆç™»å…¥";
        return;
      }

      try {
        // å–å¾— notes
        const notesRef = collection(db, "notes", user.uid, "userNotes");
        const notesSnap = await getDocs(notesRef);
        const notes = [];
        notesSnap.forEach(doc => {
          const data = doc.data();
          if (data.date === todayStr && !data.done) {
            notes.push(data);
          }
        });

        // å–å¾— events
        const eventsRef = collection(db, "events", user.uid, "userEvents");
        const eventsSnap = await getDocs(eventsRef);
        const events = [];
        eventsSnap.forEach(doc => {
          const data = doc.data();
          if (data.date === todayStr) {
            events.push(data);
          }
        });

        const combined = [...notes, ...events];

        if (combined.length === 0) {
          taskEl.textContent = "No tasks today ğŸ‰";
          return;
        }

        // æ’åºï¼ˆå…ˆæœ‰ time å†ç„¡ timeï¼‰
        combined.sort((a, b) => {
          if (a.time && b.time) return a.time.localeCompare(b.time);
          if (a.time) return -1;
          if (b.time) return 1;
          return 0;
        });

        const main = combined[0];

        const html = `
      <div style="position: relative; text-align: center;">
        <span>${main.time ? `${main.time} - ${main.title}` : main.title}</span>
        ${combined.length > 1 ? `<span style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); color:#999; font-size:12px;">+${combined.length - 1}</span>` : ""}
      </div>
    `;

        taskEl.innerHTML = html;
      } catch (err) {
        console.error("è®€å– Firebase è³‡æ–™éŒ¯èª¤ï¼š", err);
        taskEl.textContent = "è¼‰å…¥å¤±æ•—";
      }
    }

    function getLocalDateStr() {
      const now = new Date();
      const year = now.getFullYear();
      const month = (now.getMonth() + 1).toString().padStart(2, "0");
      const day = now.getDate().toString().padStart(2, "0");
      return `${year}-${month}-${day}`;
    }
    //mood_______________________________________________________________________
    // import { doc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    document.getElementById('mood-options').addEventListener('click', async e => {
      if (e.target.dataset.mood) {
        const mood = e.target.dataset.mood;
        const user = auth.currentUser;

        if (!user) {
          alert("è«‹å…ˆç™»å…¥æ‰èƒ½ç´€éŒ„å¿ƒæƒ…");
          return;
        }

        try {
          const userDocRef = doc(db, "moods", user.uid);
          const userMoodsColRef = collection(userDocRef, "userMoods");
          await addDoc(userMoodsColRef, {
            mood: mood,
            time: serverTimestamp(),
          });
          alert(`ä½ é¸æ“‡äº†å¿ƒæƒ…ï¼š${mood}`);
        } catch (error) {
          console.error("å„²å­˜å¿ƒæƒ…éŒ¯èª¤ï¼š", error);
          alert("å„²å­˜å¿ƒæƒ…å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      }
    });
    // æ­·å²ç´€éŒ„æŒ‰éˆ•
    document.getElementById('show-history').addEventListener('click', () => {
      window.location.href = "mood.html";
    });
    //Timeline_______________________________________________________________________
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loadTodayTimeline(user);
      }
    });

    async function loadTodayTimeline(user) {
      const today = new Date().toISOString().slice(0, 10);

      const plansQ = query(
        collection(db, "plans", user.uid, "dailyPlans"),
        where("date", "==", today)
      );
      const eventsQ = query(
        collection(db, "events", user.uid, "userEvents"),
        where("date", "==", today)
      );

      try {
        const [plansSnap, eventsSnap] = await Promise.all([
          getDocs(plansQ),
          getDocs(eventsQ)
        ]);

        const plans = plansSnap.docs.map(doc => doc.data());
        const events = eventsSnap.docs.map(doc => ({
          time: doc.data().time,
          title: doc.data().title
        }));

        const allItems = [...plans, ...events];

        // ğŸ‘‰ æ–°å¢ Now é»
        const now = new Date();
        const nowHour = now.getHours().toString().padStart(2, '0');
        const nowMin = now.getMinutes().toString().padStart(2, '0');
        const nowTime = `${nowHour}:${nowMin}`;

        allItems.push({
          time: nowTime,
          title: 'Now',
          isNow: true
        });

        // âš ï¸ å®‰å…¨æª¢æŸ¥
        allItems.forEach((item, idx) => {
          if (!item || typeof item !== 'object') {
            console.warn(`âš ï¸ ç¬¬ ${idx} ç­†æ˜¯ null æˆ– undefinedï¼š`, item);
          } else if (!item.time || typeof item.time !== 'string') {
            console.warn(`âš ï¸ ç¬¬ ${idx} ç­†ç¼ºå°‘æœ‰æ•ˆ timeï¼š`, item);
          }
        });

        allItems.sort((a, b) => convertTo24Hour(a.time).localeCompare(convertTo24Hour(b.time)));

        drawTimelinePoints(allItems);
      } catch (error) {
        console.error("è¼‰å…¥æ¯æ—¥æ™‚é–“ç·šå¤±æ•—ï¼š", error);
      }
    }

    function drawTimelinePoints(items) {
      const timelineBar = document.getElementById("timeline-bar");
      timelineBar.innerHTML = ''; // æ¸…ç©º

      items.forEach(item => {
        const point = document.createElement("div");
        point.className = "timeline-point";

        const timeLabel = document.createElement("div");
        timeLabel.className = "time";
        timeLabel.textContent = item.time;

        const dot = document.createElement("div");
        dot.className = "dot";

        const titleLabel = document.createElement("div");
        titleLabel.className = "title";
        titleLabel.textContent = item.title;

        // ğŸ‘‰ æ¨™è¨˜ Now é»ï¼ˆæ¨£å¼ä¸åŒï¼‰
        if (item.isNow) {
          point.classList.add("now-point");
          dot.style.backgroundColor = "#d581a1"; // ç²‰ç´…è‰²
          dot.style.border = "2px solid white";
        }

        point.appendChild(timeLabel);
        point.appendChild(dot);
        point.appendChild(titleLabel);
        timelineBar.appendChild(point);
      });
    }

    function convertTo24Hour(timeStr) {
      if (!timeStr || typeof timeStr !== 'string') {
        console.warn("â›”ï¸ ç„¡æ•ˆæ™‚é–“æ ¼å¼ï¼š", timeStr);
        return '00:00';
      }

      // å¦‚æœæ˜¯ 24 å°æ™‚åˆ¶æ ¼å¼ï¼Œç›´æ¥å›å‚³
      if (/^\d{2}:\d{2}$/.test(timeStr)) {
        return timeStr;
      }

      // å¦å‰‡è™•ç†ä¸Šåˆ/ä¸‹åˆæ ¼å¼
      const [ampm, time] = timeStr.split(' ');
      if (!ampm || !time) return '00:00';

      let [hours, minutes] = time.split(':').map(Number);
      if (ampm === 'ä¸‹åˆ' && hours < 12) hours += 12;
      if (ampm === 'ä¸Šåˆ' && hours === 12) hours = 0;
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }



  </script>



</body>

</html>
